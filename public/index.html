<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-tasks"></i> Task Manager</h1>
            <div class="user-info">
                <span id="user-name">Loading...</span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="statistics">
            <div class="stat-item">
                <div class="stat-value" id="total-tasks">0</div>
                <div class="stat-label">Total Tasks</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="completed-tasks">0</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="pending-tasks">0</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>

        <!-- Search and Sort -->
        <div class="search-sort">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search tasks...">
                <i class="fas fa-search"></i>
            </div>
            <select id="sort-select">
                <option value="dueDate">Sort by Due Date</option>
                <option value="priority">Sort by Priority</option>
                <option value="title">Sort by Title</option>
                <option value="createdAt">Sort by Created Date</option>
            </select>
        </div>

        <!-- Task Input -->
        <div class="task-input">
            <input type="text" id="task-title" placeholder="Enter task title..." required>
            <input type="text" id="task-description" placeholder="Enter description...">
            <input type="date" id="task-due-date">
            <input type="time" id="task-due-time"> <!-- ✅ New due time field -->
            <select id="task-priority">
                <option value="low">Low Priority</option>
                <option value="medium" selected>Medium Priority</option>
                <option value="high">High Priority</option>
            </select>
            <button onclick="addTask()"><i class="fas fa-plus"></i> Add Task</button>
        </div>

        <!-- Filters -->
        <div class="filters">
            <button onclick="filterTasks('all')" class="filter-btn active">All</button>
            <button onclick="filterTasks('pending')" class="filter-btn">Pending</button>
            <button onclick="filterTasks('completed')" class="filter-btn">Completed</button>
            <button onclick="filterTasks('high')" class="filter-btn">High Priority</button>
        </div>

        <!-- Task List -->
        <ul id="task-list">
            <!-- Tasks will be loaded here -->
        </ul>
    </div>

    <!-- Edit Task Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>Edit Task</h2>
            <input type="text" id="edit-title" placeholder="Task title">
            <input type="text" id="edit-description" placeholder="Task description">
            <input type="date" id="edit-due-date">
            <input type="time" id="edit-due-time"> 
                <option value="low">Low Priority</option>
                <option value="medium">Medium Priority</option>
                <option value="high">High Priority</option>
            </select>
            <button onclick="saveEdit()">Save Changes</button>
        </div>
    </div>

    <script>
        let tasks = [];
        let currentFilter = 'all';
        let editingTaskId = null;

        // Get the current port from the server
        const getServerPort = async () => {
            try {
                const response = await fetch('/api/port');
                const data = await response.json();
                return data.port;
            } catch (error) {
                console.error('Error getting server port:', error);
                return 3001; // Default port
            }
        };

        // Check authentication
        const checkAuth = () => {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (!token || !user) {
                window.location.href = '/auth';
                return false;
            }
            
            document.getElementById('user-name').textContent = JSON.parse(user).name;
            return true;
        };

        // Logout function
        const logout = () => {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/auth';
        };

        // Get authentication headers
        const getAuthHeaders = () => {
            const token = localStorage.getItem('token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        };

        // Load tasks from server
        const loadTasks = async () => {
            try {
                const port = await getServerPort();
                const response = await fetch(`http://localhost:${port}/api/tasks`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    tasks = await response.json();
                    displayTasks();
                    updateStatistics();
                } else if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
                showNotification('Error loading tasks', 'error');
            }
        };

        // Display tasks
        const displayTasks = () => {
            const taskList = document.getElementById('task-list');
            const filteredTasks = filterTasksByType(tasks);
            
            taskList.innerHTML = '';
            
            if (filteredTasks.length === 0) {
                taskList.innerHTML = '<li style="text-align: center; color: #666;">No tasks found</li>';
                return;
            }
            
            filteredTasks.forEach(task => {
                const li = document.createElement('li');
                li.className = `priority-${task.priority}`;
                if (task.completed) li.classList.add('completed');
                
                const dueDate = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No due date';
                const dueTime = task.dueTime ? task.dueTime : ''; // ✅ New
                const statusText = task.completed ? 'Completed' : 'Pending';
                
                li.innerHTML = `
                    <div class="task-content">
                        <div class="task-toggle-container">
                            <label class="task-toggle">
                                <input type="checkbox" ${task.completed ? 'checked' : ''} 
                                       onchange="toggleTask('${task._id}')">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">${statusText}</span>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold;">${task.title}</div>
                            ${task.description ? `<div style="color: #666; font-size: 0.9em;">${task.description}</div>` : ''}
                            <div class="due-date">Due: ${dueDate} ${dueTime}</div>
                        </div>
                        <div class="task-actions">
                            <button onclick="editTask('${task._id}')" style="background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-right: 5px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteTask('${task._id}')" class="delete-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                taskList.appendChild(li);
            });
        };

        // Filter tasks by type
        const filterTasksByType = (taskList) => {
            switch (currentFilter) {
                case 'pending':
                    return taskList.filter(task => !task.completed);
                case 'completed':
                    return taskList.filter(task => task.completed);
                case 'high':
                    return taskList.filter(task => task.priority === 'high');
                default:
                    return taskList;
            }
        };

        // Update statistics
        const updateStatistics = () => {
            const total = tasks.length;
            const completed = tasks.filter(task => task.completed).length;
            const pending = total - completed;
            
            document.getElementById('total-tasks').textContent = total;
            document.getElementById('completed-tasks').textContent = completed;
            document.getElementById('pending-tasks').textContent = pending;
        };

        // Add new task
        const addTask = async () => {
            const title = document.getElementById('task-title').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const dueDate = document.getElementById('task-due-date').value;
            const dueTime = document.getElementById('task-due-time').value; // ✅ New
            const priority = document.getElementById('task-priority').value;
            
            if (!title) {
                showNotification('Please enter a task title', 'error');
                return;
            }
            
            try {
                const port = await getServerPort();
                const response = await fetch(`http://localhost:${port}/api/tasks`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        title,
                        description: description || undefined,
                        dueDate: dueDate || undefined,
                        dueTime: dueTime || undefined, // ✅ Send to backend
                        priority
                    })
                });
                
                if (response.ok) {
                    const newTask = await response.json();
                    tasks.push(newTask);
                    displayTasks();
                    updateStatistics();
                    
                    // Clear form
                    document.getElementById('task-title').value = '';
                    document.getElementById('task-description').value = '';
                    document.getElementById('task-due-date').value = '';
                    document.getElementById('task-due-time').value = '';
                    document.getElementById('task-priority').value = 'medium';
                    
                    showNotification('Task added successfully', 'success');
                } else {
                    showNotification('Error adding task', 'error');
                }
            } catch (error) {
                console.error('Error adding task:', error);
                showNotification('Error adding task', 'error');
            }
        };

        // Toggle task completion
        const toggleTask = async (taskId) => {
            const task = tasks.find(t => t._id === taskId);
            if (!task) return;
            
            try {
                const port = await getServerPort();
                const response = await fetch(`http://localhost:${port}/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        completed: !task.completed
                    })
                });
                
                if (response.ok) {
                    task.completed = !task.completed;
                    displayTasks();
                    updateStatistics();
                    showNotification('Task updated', 'success');
                } else {
                    showNotification('Error updating task', 'error');
                }
            } catch (error) {
                console.error('Error updating task:', error);
                showNotification('Error updating task', 'error');
            }
        };

        // Edit task
        const editTask = (taskId) => {
            const task = tasks.find(t => t._id === taskId);
            if (!task) return;
            
            editingTaskId = taskId;
            document.getElementById('edit-title').value = task.title;
            document.getElementById('edit-description').value = task.description || '';
            document.getElementById('edit-due-date').value = task.dueDate ? task.dueDate.split('T')[0] : '';
            document.getElementById('edit-due-time').value = task.dueTime || ''; // ✅ New
            document.getElementById('edit-priority').value = task.priority;
            
            document.getElementById('editModal').style.display = 'block';
        };

        // Save edit
        const saveEdit = async () => {
            if (!editingTaskId) return;
            
            const title = document.getElementById('edit-title').value.trim();
            const description = document.getElementById('edit-description').value.trim();
            const dueDate = document.getElementById('edit-due-date').value;
            const dueTime = document.getElementById('edit-due-time').value; // ✅ New
            const priority = document.getElementById('edit-priority').value;
            
            if (!title) {
                showNotification('Please enter a task title', 'error');
                return;
            }
            
            try {
                const port = await getServerPort();
                const response = await fetch(`http://localhost:${port}/api/tasks/${editingTaskId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        title,
                        description: description || undefined,
                        dueDate: dueDate || undefined,
                        dueTime: dueTime || undefined, // ✅ Save time
                        priority
                    })
                });
                
                if (response.ok) {
                    const updatedTask = await response.json();
                    const index = tasks.findIndex(t => t._id === editingTaskId);
                    if (index !== -1) {
                        tasks[index] = updatedTask;
                    }
                    displayTasks();
                    closeEditModal();
                    showNotification('Task updated successfully', 'success');
                } else {
                    showNotification('Error updating task', 'error');
                }
            } catch (error) {
                console.error('Error updating task:', error);
                showNotification('Error updating task', 'error');
            }
        };

        // Delete task
        const deleteTask = async (taskId) => {
            if (!confirm('Are you sure you want to delete this task?')) return;
            
            try {
                const port = await getServerPort();
                const response = await fetch(`http://localhost:${port}/api/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    tasks = tasks.filter(t => t._id !== taskId);
                    displayTasks();
                    updateStatistics();
                    showNotification('Task deleted successfully', 'success');
                } else {
                    showNotification('Error deleting task', 'error');
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                showNotification('Error deleting task', 'error');
            }
        };

        // Filter tasks
        const filterTasks = (filter) => {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            displayTasks();
        };

        // Close edit modal
        const closeEditModal = () => {
            document.getElementById('editModal').style.display = 'none';
            editingTaskId = null;
        };

        // Show notification
        const showNotification = (message, type = 'info') => {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        };

        // Search functionality
        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredTasks = tasks.filter(task => 
                task.title.toLowerCase().includes(searchTerm) ||
                (task.description && task.description.toLowerCase().includes(searchTerm))
            );
            
            // Temporarily replace tasks for display
            const originalTasks = tasks;
            tasks = filteredTasks;
            displayTasks();
            tasks = originalTasks;
        });

        // Sort functionality
        document.getElementById('sort-select').addEventListener('change', (e) => {
            const sortBy = e.target.value;
            tasks.sort((a, b) => {
                switch (sortBy) {
                    case 'dueDate':
                        return new Date(a.dueDate || '9999-12-31') - new Date(b.dueDate || '9999-12-31');
                    case 'priority':
                        const priorityOrder = { high: 3, medium: 2, low: 1 };
                        return priorityOrder[b.priority] - priorityOrder[a.priority];
                    case 'title':
                        return a.title.localeCompare(b.title);
                    case 'createdAt':
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    default:
                        return 0;
                }
            });
            displayTasks();
        });

        // Close modal when clicking outside
        window.onclick = (event) => {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeEditModal();
            }
        };

        // Initialize app
        if (checkAuth()) {
            loadTasks();
        }
    </script>
</body>
</html>



